{% extends 'posts/base.html' %}
{% load i18n %}
{% load comments_threaded_tags %}

{% block posts_title %}{% endblock posts_title %}
{% block posts_content %}
  <style scoped>
    ul.list-unstyled.b-comment__tree li {
      margin-left: 28px;
    }
    ul.list-unstyled.b-comment__tree>li {
      margin-left: 0px;
    }

    div.comment {
      position: relative;
    }


    .b-comment__thread {
      margin-left: 0 !important;
    }
    div.b-comment__head {
      padding-left: 70px;
    }

    div.b-comment__head a.b-comment__user img {
      margin-left: -90px;
      position: absolute;
    }

    div.b-comment__head div.b-comment__datetime {
/*      display: inline-block;*/
    }
 
    div.b-comment__text,
    div.b-comment__foot {
      padding-left: 70px;
    }

    div.b-comment__text {
      padding-right: 40px;
    }

    div.b-comment__head a.b-comment__user > span {
      font-weight: bold;
    }

    div.b-comment__rating {
      position: absolute;
      top: 0;
      right: 0;
      padding: 2px 4px;
    }
    div.rating {
      color: #666;
      background-color:#e7e7e7;
    }

  </style>
  <div ng-app="django-comments-threaded">
    <div class="container" >
      <h1>{{ object }}</h1>
        {% get_comment_api_urls object as api_urls %}
        {% get_comment_form object as create_form %}

        <script type="text/ng-template" id="comment_item.html">
          <div class="comment" id="comment-{$ comment.id $}">
            <a name="comment-{$ comment.id $}"></a>
            <div class="b-comment__head">
              <a href="#" class="b-comment__user">
                <span>{$ comment.user_name $}</span>
                <img src="http://static42.siliconrus.cmtt.ru/user-userpic/7c/9b/cc4c801876.jpg">
              </a>
              <div class="b-comment__datetime">
                <a href="#comment-{$ comment.id $}">
                  <time class="timeago" datetime="{$ comment.date_created $}" title="{$ comment.date_created | date $}">{$ comment.date_created | date $}</time>
                </a>
              </div>
            </div>
            <div class="b-comment__text" ng-bind-html="comment.message | nl2br">
            </div>
            <div class="b-comment__rating rating b-comment__rating ">
              <div class="b-comment__rating__count rating-count">0</div>
            </div>
          </div>
          <div class="b-comment__foot">
            <a href="#" ng-click="reply(comment)">reply</a>
            <a href="#" ng-click="delete(comment)" ng-show="0">delete</a>
          </div>
          <div ng-if=""></div>
          <p ng-if="(comment.level >= maxLevel - 1) && (comment.rght-comment.lft > 1) && (openedThreads.indexOf(comment.tree_id) == -1)">
            <a ng-href="#" ng-click="toggleThread(comment)">More {$ comment | threadSize $}</a>
          </p>
          <ul ng-class="b-comment__thread" ng-if="(comment.level <  maxLevel - 1) || openedThreads.indexOf(comment.tree_id) != -1 " class="list-unstyled">
            <li ng-repeat="comment in comment.replies" ng-include="'comment_item.html'"></li>
          </ul>
        </script>

        <div ng-controller="CommentTreeCtrl" ng-init="maxLevel=5">
          <ul class="list-unstyled b-comment__tree">
            <li ng-repeat="comment in tree" ng-include="'comment_item.html'"></li>
          </ul>
          <form ng-controller="CommentCreateCtrl" name="createForm" ng-submit="create()">
            {% for f in create_form.hidden_fields %}{{ f }}{% endfor %}
            {% for f in create_form.visible_fields %}
              <div class="form-group">
                {# {{ f.label_tag }} #}
                {{ f }}
              </div>
            {% endfor %}
            <button ng-disabled="isSubmitting || (createForm.$valid && createForm.$dirty)" type="submit" class="btn btn-default">{% trans 'create comment' %}</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <script>window.ctf = {
    create: "{{ api_urls.list_create }}",
    tree: "{{ api_urls.tree }}",
    csrf: "{{ csrf_token }}"
  }
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-cookies.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-sanitize.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js"></script>
  <script>
var
  deps = ["ngSanitize", "ngCookies"],
  app = angular.module("django-comments-threaded", deps)
;
app
  .provider("djangoAjax", [
    function() {
      var
        headerName = "X-CSRFToken",
        xhrHeaderName = "X-Requested-With",
        xhrHeaderValue = "XMLHttpRequest",
        cookieName = "csrftoken"
      ;
      return {
        $get: ["$cookies", function($cookies) {
          return {
            "request": function(config) {
              config.headers[headerName] = $cookies[cookieName];
              config.headers[xhrHeaderName] = xhrHeaderValue;
              return config;
            }
          };
        }
      ]
    };
  }])
  .config(["$interpolateProvider", "$rootScopeProvider", "$httpProvider", function($interpolateProvider, $rootScopeProvider, $httpProvider){
    $httpProvider.interceptors.push("djangoAjax");
    $interpolateProvider.startSymbol("{$");
    $interpolateProvider.endSymbol("$}");
    $rootScopeProvider.digestTtl(15);

  }])
  .filter("nl2br", ["$sanitize", function($sce){
    return function(string){
      return $sce((string + "").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, "$1<br>$2"));
    };
  }])
  .filter("threadSize", function(){
    return function(comment) {
      return parseInt((comment.rght - comment.lft) / 2);
    };
  })
  .controller("CommentTreeCtrl", ["$scope", "$http", "$log", function($scope, $http, $log){
    $http
      .get(ctf.tree)
      .success(function(tree){
        $scope.tree = tree;
      });

    $scope.openedThreads = [];
    $scope.toggleThread = function(comment){
      $scope.openedThreads.push(comment.tree_id);
    }
    $scope.mainThread = function(comment, maxLevel){
      return comment.level <= maxLevel - 1;
    };
    $scope.threadSize = function(comment){
      return parseInt((comment.rght - comment.lft) / 2)
    };
    $scope.delete = function(comment){
      $http
        .delete(comment.comment_url)
        .success(function(json){
          $log.info("Successfully deleted")
        })
        .error(function(json){
          $log.info("Error during comment deletion", json)
        })
      ;
    };

    $scope.reply = function(comment){
      $http
        .post(comment.comment_url, {'message': 'sfsdfsdf'})
        .success(function(json){
          if (typeof comment.replies == "undefined") {
            comment.replies = []
          }
          comment.replies.push(json);
        })
        .error(function(json){
        })
      ;
    };

  }])
  .controller("CommentCreateCtrl", ["$scope", "$http", function($scope, $http){
    $scope.newComment = {};
    $scope.isSubmitting = false;

    $scope.create = function(){
      $scope.isSubmitting = true;
      $http
        .post(ctf.create, $scope.newComment)
        .success(function(json){
          $scope.isSubmitting = false;
          $scope.new_comment = {};
          $scope.$parent.tree.push(json);
        })
        .error(function(json){
          console.log('error', json);
          $scope.isSubmitting = false;
        })
      ;
    }
  }])
;
  </script>
{% endblock posts_content %}

{% extends 'posts/base.html' %}
{% load i18n %}
{% load comments_threaded_tags %}

{% block posts_title %}{% endblock posts_title %}
{% block posts_content %}
  <div ng-app="django-comments-threaded">
    <div class="container" >
      <h1>{{ object }}</h1>
    </div>
    {% get_comment_api_urls object as api_urls %}
    {% get_comment_form object as create_form %}

    <script type="text/ng-template" id="comment_item.html">
      <p>{$ comment.author_name $}, <a href="#comment-{$ comment.id $}">{$ comment.date_created | date $}</a></p>
      <div>{$ comment.message $}</div>
      <p class="center">
        <a href="#" ng-click="reply(comment)">reply</a>
        <a href="#" ng-click="delete(comment)" ng-show="0">delete</a>
      </p>
      <p ng-if="(comment.level >= maxLevel - 1) && (comment.rght-comment.lft > 1) && (openedThreads.indexOf(comment.tree_id) == -1)">
        <a ng-href="#" ng-click="toggleThread(comment)">More {$ comment | threadSize $}</a>
      </p>
      <ul ng-if="(comment.level <  maxLevel - 1) || openedThreads.indexOf(comment.tree_id) != -1 ">
        <li ng-repeat="comment in comment.replies" ng-include="'comment_item.html'"></li>
      </ul>
    </script>

    <div ng-controller="CommentTreeCtrl" ng-init="maxLevel=5">
      <ul>
        <li ng-repeat="comment in tree" ng-include="'comment_item.html'"></li>
      </ul>
    </div>

    <div class="well">
      <form id="frm_comment_create" action="">
        {{ create_form }}
        <div class="">
          <input type="submit" value="Send">
        </div>
      </form>
    </div>

    <script>window.ctf = {
      create: "{{ api_urls.list_create }}",
      tree: "{{ api_urls.tree }}"
    }
    </script>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js"></script>
  <script>
var
  deps = [],
  app = angular.module("django-comments-threaded", [])
;
app
  .config(["$interpolateProvider", "$rootScopeProvider", function($interpolateProvider, $rootScopeProvider){
    $interpolateProvider.startSymbol("{$");
    $interpolateProvider.endSymbol("$}");
    $rootScopeProvider.digestTtl(15);

  }])
  .filter("threadSize", function(){
    return function(comment) {
      return parseInt((comment.rght - comment.lft) / 2);
    };
  })
  .controller("CommentTreeCtrl", ["$scope", "$http", "$log", function($scope, $http, $log){
    $http
      .get(ctf.tree)
      .success(function(tree){
        $scope.tree = tree;
      });

    $scope.openedThreads = [];
    $scope.toggleThread = function(comment){
      $scope.openedThreads.push(comment.tree_id);
    }
    $scope.mainThread = function(comment, maxLevel){
      return comment.level <= maxLevel - 1;
    };
    $scope.threadSize = function(comment){
      return parseInt((comment.rght - comment.lft) / 2)
    };
    $scope.delete = function(comment){
      $http
        .delete(comment.comment_url)
        .success(function(json){
          $log.info("Successfully deleted")
        })
        .error(function(json){
          $log.info("Error during comment deletion", json)
        })
      ;
    };

    $scope.reply = function(comment){
      $http
        .post(comment.comment_url, {'message': 'sfsdfsdf'})
        .success(function(json){
          if (typeof comment.replies == "undefined") {
            comment.replies = []
          }
          comment.replies.push(json);
        })
        .error(function(json){
        })
      ;
    };

  }])
  .controller("CommentCreate", ["$scope", function($scope){

  }])
;
  </script>
{% endblock posts_content %}
